!function(root,factory){"function"==typeof define&&define.amd?define([],factory):"object"==typeof exports?module.exports=factory():root.structuredLog=factory()}(this,function(){function expectString(val){if(!val||"string"!=typeof val)throw new Error("Expected "+typeof val+" to be a string.")}function expectFunction(val){if(!val||"function"!=typeof val)throw new Error("Expected "+typeof val+" to be a function.")}function expectObject(val){if(!val||"object"!=typeof val)throw new Error("Expected "+typeof val+" to be an object.")}function expectArray(val){if(!val||"[object Array]"!==Object.prototype.toString.call(val))throw new Error("Expected "+typeof val+" to be an array.")}function MessageTemplate(messageTemplate){var self=this;self.raw=messageTemplate,self.tokens=[];for(var res,ptre=/\{@?\w+}/g,textStart=0;null!==(res=ptre.exec(messageTemplate));){res.index!==textStart&&self.tokens.push({text:messageTemplate.slice(textStart,res.index)});var destructure=!1,tok=res[0].slice(1,-1);0===tok.indexOf("@")&&(tok=tok.slice(1),destructure=!0),self.tokens.push({name:tok,destructure:destructure,raw:res[0]}),textStart=ptre.lastIndex}textStart>=0&&textStart<messageTemplate.length&&self.tokens.push({text:messageTemplate.slice(textStart)})}function LogEvent(timestamp,level,messageTemplate,properties){var self=this;self.timestamp=timestamp,self.level=level,self.messageTemplate=messageTemplate,self.properties=properties}function LevelMap(initial){var self=this;if(self.levels={},"OFF"!==initial)for(var sequence=[errorLevel,warnLevel,infoLevel,debugLevel,verboseLevel],below=!1,i=0;i<sequence.length;++i){var level=sequence[i];self.levels[level]=!below,level===initial&&(below=!0)}}function Pipeline(pipelineStages){if(expectArray(pipelineStages),pipelineStages.length<1)throw new Error("No pipeline stages defined!");var self=this;self.pipelineStages=pipelineStages,self.headStage=self.pipelineStages[0];for(var stageIndex=0;stageIndex<self.pipelineStages.length-1;++stageIndex){var nextStage=self.pipelineStages[stageIndex+1];self.pipelineStages[stageIndex].setNextStage(nextStage)}}function LoggerConfiguration(){var self=this,minLevel=infoLevel,pipelineStages=[];self.addStage=function(pipelineStage){return expectObject(pipelineStage),pipelineStages.push(pipelineStage),self},self.minLevel=function(lvl){if(0!==pipelineStages.length){var lm=new LevelMap(lvl);return self.filter(function(evt){return lm.isEnabled(evt.level)})}return minLevel=(lvl||infoLevel).toUpperCase(),self},self.writeTo=function(sinkOrEmit,onError){return"function"!=typeof sinkOrEmit.emit&&"function"==typeof sinkOrEmit?self.writeTo({emit:sinkOrEmit,toString:function(){return"function"}},onError):self.addStage(new SinkStage(sinkOrEmit.toString(),sinkOrEmit.emit,sinkOrEmit.flush,sinkOrEmit.close,onError))},self.enrich=function(functionOrProperties,destructure){if("object"==typeof functionOrProperties)return self.enrich(function(){return functionOrProperties},destructure);if("function"==typeof functionOrProperties)return self.addStage(new EnrichStage(functionOrProperties,destructure));throw new Error("Events can be enriched using either a function, or a hash of properties")},self.filter=function(filter){return self.addStage(new FilterStage(filter))},self.batch=function(batchOptions){return self.addStage(new BatchStage(batchOptions||{}))},self.create=function(){return createLogger(new LevelMap(minLevel),new Pipeline(pipelineStages))}}function StructuredLog(){var self=this;self.sink={},self.filter={},self.enrich={},self.filter.selfLog=function(){return function(evts){return evts.filter(function(evt){return evt.properties.isSelfLog})}},self.filter.notSelfLog=function(){return function(evts){return evts.filter(function(evt){return!evt.properties.isSelfLog})}},self.enrich.withStack=function(){return function(evts){try{throw new Error("getstack")}catch(err){var stack=err.stack;0===stack.indexOf("Error: getstack")&&(stack=stack.slice(stack.indexOf("\n")+1)),stack=stack.replace(/^[ ]+/g,""),evts.forEach(function(evt){evt.properties.hasOwnProperty("stack")||(evt.properties.stack=stack)})}}}}var capture=function(o,destructure){return"function"==typeof o?o.toString():"object"==typeof o?destructure||"function"==typeof o.toISOString?o:o.toString():o};MessageTemplate.prototype.bindProperties=function(positionalArgs){for(var self=this,result={},nextArg=0,i=0;i<self.tokens.length&&nextArg<positionalArgs.length;++i){var token=self.tokens[i];if("string"==typeof token.name){var p=positionalArgs[nextArg];result[token.name]=capture(p,token.destructure),nextArg++}}for(;nextArg<positionalArgs.length;){var px=positionalArgs[nextArg];"undefined"!=typeof px&&(result["a"+nextArg]=capture(px)),nextArg++}return result};var toText=function(o){if("undefined"==typeof o)return"undefined";if(null===o)return"null";if("string"==typeof o)return o;if("number"==typeof o)return o.toString();if("boolean"==typeof o)return o.toString();if("function"==typeof o.toISOString)return o.toISOString();if("object"==typeof o){var s=JSON.stringify(o);return s.length>70&&(s=s.slice(0,67)+"..."),s}return o.toString()};MessageTemplate.prototype.render=function(properties){for(var self=this,result=[],i=0;i<self.tokens.length;++i){var token=self.tokens[i];"string"==typeof token.name?properties.hasOwnProperty(token.name)?result.push(toText(properties[token.name])):result.push(token.raw):result.push(token.text)}return result.join("")};var enrich=function(evts,properties,destructure){evts.forEach(function(evt){for(var prop in properties)properties.hasOwnProperty(prop)&&!evt.properties.hasOwnProperty(prop)&&(evt.properties[prop]=capture(properties[prop],destructure))})},createEvent=function(level,messageTemplate){var l=Array.prototype.shift.call(arguments),mt=Array.prototype.shift.call(arguments),parsedTemplate=new MessageTemplate(mt),boundProperties=parsedTemplate.bindProperties(arguments);return new LogEvent(new Date,l,parsedTemplate,boundProperties)};LogEvent.prototype.renderedMessage=function(){var self=this;return self.messageTemplate.render(self.properties)};var errorLevel="ERROR",warnLevel="WARN",infoLevel="INFO",debugLevel="DEBUG",verboseLevel="VERBOSE";LevelMap.prototype.isEnabled=function(level){var self=this;return self.levels[level||"NONE"]||!1};var runAsyncParallel=function(){var done=arguments[arguments.length-1];if(expectFunction(done),arguments.length<=1)return void done();for(var awaitingCompletion=arguments.length-1,allDone=!1,checkAllDone=function(){allDone||(--awaitingCompletion,0>=awaitingCompletion&&(allDone=!0,done()))},i=0;i<arguments.length-1;++i){var fn=arguments[i];expectFunction(fn),fn(checkAllDone)}},SinkStage=function(sinkName,sinkEmit,sinkFlush,sinkClose,onError){expectString(sinkName),expectFunction(sinkEmit),sinkFlush&&expectFunction(sinkFlush),sinkClose&&expectFunction(sinkClose),onError&&expectFunction(onError);var self=this;this.sinkName=sinkName,self.sinkEmit=sinkEmit,self.sinkFlush=sinkFlush,self.sinkClose=sinkClose,self.onError=onError};SinkStage.prototype.setNextStage=function(nextStage){expectObject(nextStage);var self=this;self.nextStage=nextStage};var errToString=function(err){return"string"==typeof err?err:err.stack?err.stack.toString():err.toString()};SinkStage.prototype.emit=function(logEvts,done){expectArray(logEvts),expectFunction(done);var self=this,sinkEmit=function(done){try{self.sinkEmit.length>1?self.sinkEmit(logEvts,done):(self.sinkEmit(logEvts),done())}catch(err){if("function"==typeof self.onError)self.onError(err,logEvts,done);else if(self.nextStage){var errLogEvt=createEvent(errorLevel,"Failed to write to {sink}: {error}",self.sinkName,errToString(err));errLogEvt.properties.isSelfLog=!0,self.nextStage.emit([errLogEvt],done)}else done()}},nextStageEmit=function(done){self.nextStage?self.nextStage.emit(logEvts,done):done()};runAsyncParallel(sinkEmit,nextStageEmit,done)},SinkStage.prototype.flush=function(done){expectFunction(done);var self=this,sinkFlush=function(done){self.sinkFlush?self.sinkFlush.length>0?self.sinkFlush(done):(self.sinkFlush(),done()):done()},nextStageFlush=function(done){self.nextStage?self.nextStage.flush(done):done()};runAsyncParallel(sinkFlush,nextStageFlush,done)},SinkStage.prototype.close=function(done){expectFunction(done);var self=this;self.flush(function(){var sinkClose=function(done){self.sinkClose?self.sinkClose.length>0?self.sinkClose(done):(self.sinkClose(),done()):done()},nextStageClose=function(done){self.nextStage?self.nextStage.close(done):done()};runAsyncParallel(sinkClose,nextStageClose,done)})};var BatchStage=function(config){expectObject(config);var self=this;self.config=config,self.batchedLogEvts=[],self.lastFlushTime=(new Date).getTime(),self.config.batchSize||(self.config.batchSize=100),self.config.timeDuration||(self.config.timeDuration=1e3)};BatchStage.prototype.setNextStage=function(nextStage){expectObject(nextStage);var self=this;self.nextStage=nextStage},BatchStage.prototype.flushBatch=function(done){expectFunction(done);var self=this;self.nextStage.emit(self.batchedLogEvts,done),self.batchedLogEvts=[]},BatchStage.prototype.startFlushTimer=function(){var self=this;self.batchFlushTimer=setTimeout(function(){self.flushBatch(function(){})},self.config.timeDuration)},BatchStage.prototype.cancelFlushTimer=function(){var self=this;self.batchFlushTimer&&(clearTimeout(self.batchFlushTimer),self.batchFlushTimer=null)},BatchStage.prototype.emit=function(logEvts,done){expectArray(logEvts),expectFunction(done);var self=this;self.cancelFlushTimer();(new Date).getTime();self.batchedLogEvts=self.batchedLogEvts.concat(logEvts);var needsFlushNow=self.batchedLogEvts.length>=self.config.batchSize||self.config.timeDuration&&self.curTime-self.lastFlushTime>self.config.timeDuration;needsFlushNow?self.flushBatch(function(){}):(self.startFlushTimer(),done())},BatchStage.prototype.flush=function(done){expectFunction(done);var self=this;self.batchedLogEvts.length>0?(self.nextStage.emit(self.batchedLogEvts,function(){self.nextStage.flush(done)}),self.batchedLogEvts=[]):self.nextStage.flush(done)},BatchStage.prototype.close=function(done){expectFunction(done);var self=this;self.flush(function(){self.nextStage.close(done)})};var FilterStage=function(filterPredicate){expectFunction(filterPredicate);var self=this;self.filterPredicate=filterPredicate};FilterStage.prototype.setNextStage=function(nextStage){expectObject(nextStage);var self=this;self.nextStage=nextStage},FilterStage.prototype.emit=function(logEvts,done){expectArray(logEvts),expectFunction(done);var self=this,filteredLogEvts=logEvts.filter(self.filterPredicate);return filteredLogEvts.length>0?void self.nextStage.emit(filteredLogEvts,done):void 0},FilterStage.prototype.flush=function(done){expectFunction(done);var self=this;self.nextStage.flush(done)},FilterStage.prototype.close=function(done){expectFunction(done);var self=this;self.flush(function(){self.nextStage.close(done)})};var EnrichStage=function(enrichFn,destructure){expectFunction(enrichFn);var self=this;self.enrichFn=enrichFn,self.destructure=destructure};EnrichStage.prototype.setNextStage=function(nextStage){expectObject(nextStage);var self=this;self.nextStage=nextStage},EnrichStage.prototype.emit=function(logEvts,done){expectArray(logEvts),expectFunction(done);var self=this;enrich(logEvts,self.enrichFn(),self.destructure),self.nextStage.emit(logEvts,done)},EnrichStage.prototype.flush=function(done){expectFunction(done);var self=this;self.nextStage.flush(done)},EnrichStage.prototype.close=function(done){expectFunction(done);var self=this;self.flush(function(){self.nextStage.close(done)})};var SubPipelineStage=function(pipeline){expectObject(pipeline);var self=this;self.pipeline=pipeline};SubPipelineStage.prototype.setNextStage=function(nextStage){expectObject(nextStage);var self=this;self.nextStage=nextStage},SubPipelineStage.prototype.emit=function(logEvts,done){expectArray(logEvts),expectFunction(done);var self=this,pipelineEmit=function(done){self.pipeline.emit(logEvts,done)},nextStageEmit=function(done){self.nextStage?self.nextStage.emit(logEvts,done):done()};runAsyncParallel(pipelineEmit,nextStageEmit,done)},SubPipelineStage.prototype.flush=function(done){expectFunction(done);var self=this,pipelineFlush=function(done){self.pipeline.flush(done)},nextStageFlush=function(done){self.nextStage?self.nextStage.flush(done):done()};runAsyncParallel(pipelineFlush,nextStageFlush,done)},SubPipelineStage.prototype.close=function(done){expectFunction(done);var self=this;self.flush(function(){var pipelineClose=function(done){self.pipeline.close(done)},nextStageClose=function(done){self.nextStage?self.nextStage.close(done):done()};runAsyncParallel(pipelineClose,nextStageClose,done)})},Pipeline.prototype.emit=function(logEvts,done){var self=this;self.headStage.emit(logEvts,done)},Pipeline.prototype.flush=function(done){var self=this;self.headStage.flush(done)},Pipeline.prototype.close=function(done){var self=this;self.headStage.close(done)};var createLogger=function(levelMap,pipeline){var self=function(){self.info.apply(null,arguments)};self.toString=function(){return"Logger"},self.emit=function(logEvts){logEvts=logEvts.filter(function(evt){return levelMap.isEnabled(evt.level)}),pipeline.emit(logEvts,function(){})};var invoke=function(level,messageTemplate,args){if(levelMap.isEnabled(level)){var parsedTemplate=new MessageTemplate(messageTemplate),boundProperties=parsedTemplate.bindProperties(args),evt=new LogEvent(new Date,level,parsedTemplate,boundProperties);pipeline.emit([evt],function(){})}};return self.verbose=function(messageTemplate){var mt=Array.prototype.shift.call(arguments);invoke(verboseLevel,mt,arguments)},self.debug=function(messageTemplate){var mt=Array.prototype.shift.call(arguments);invoke(debugLevel,mt,arguments)},self.info=function(messageTemplate){var mt=Array.prototype.shift.call(arguments);invoke(infoLevel,mt,arguments)},self.warn=function(messageTemplate){var mt=Array.prototype.shift.call(arguments);invoke(warnLevel,mt,arguments)},self.error=function(messageTemplate){var mt=Array.prototype.shift.call(arguments);invoke(errorLevel,mt,arguments)},self.enrich=function(properties,destructure){var enrichedPipeline=new Pipeline([new EnrichStage(function(){return properties},destructure),new SubPipelineStage(pipeline)]);return createLogger(levelMap,enrichedPipeline)},self.flush=function(done){pipeline.flush(done)},self.close=function(done){pipeline.close(done)},self};return StructuredLog.prototype.configure=function(){return new LoggerConfiguration},StructuredLog.prototype.event=createEvent,new StructuredLog});
!function(root,factory){"function"==typeof define&&define.amd?define([],factory):"object"==typeof exports?module.exports=factory():root.structuredLog.sink.console=factory()}(this,function(){function ConsoleSink(options){var self=this;self.toString=function(){return"ConsoleSink"},options=options||{};var write={log:function(){},info:function(){},warn:function(){},error:function(){}};"object"==typeof console&&(write.log=function(m,p){p?console.log(m,p):console.log(m)},write.info=function(m,p){p?console.info(m,p):console.info(m)},write.warn=function(m,p){p?console.warn(m,p):console.warn(m)},write.error=function(m,p){p?console.error(m,p):console.error(m)}),self.emit=function(evts){evts.forEach(function(evt){var formatted="";options.timestamp&&(formatted+=evt.timestamp.toISOString().replace("T"," ").replace("Z","")+" "),formatted+="["+evt.level.slice(0,3)+"] "+evt.messageTemplate.render(evt.properties),"ERROR"===evt.level?write.error(formatted,options.complete?evt.properties:null):"WARN"===evt.level?write.warn(formatted,options.complete?evt.properties:null):"INFO"===evt.level?write.info(formatted,options.complete?evt.properties:null):write.log(formatted,options.complete?evt.properties:null)})}}return function(options){return new ConsoleSink(options)}});