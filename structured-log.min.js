!function(root,factory){"function"==typeof define&&define.amd?define([],factory):"object"==typeof exports?module.exports=factory():root.structuredLog=factory()}(this,function(){function MessageTemplate(messageTemplate){var self=this;self.raw=messageTemplate,self.tokens=[];for(var res,ptre=/\{@?\w+}/g,textStart=0;null!==(res=ptre.exec(messageTemplate));){res.index!==textStart&&self.tokens.push({text:messageTemplate.slice(textStart,res.index)});var destructure=!1,tok=res[0].slice(1,-1);0===tok.indexOf("@")&&(tok=tok.slice(1),destructure=!0),self.tokens.push({name:tok,destructure:destructure,raw:res[0]}),textStart=ptre.lastIndex}textStart>=0&&textStart<messageTemplate.length&&self.tokens.push({text:messageTemplate.slice(textStart)})}function LogEvent(timestamp,level,messageTemplate,properties){var self=this;self.timestamp=timestamp,self.level=level,self.messageTemplate=messageTemplate,self.properties=properties}function LevelMap(initial){var self=this;if(self.levels={},"OFF"!==initial)for(var sequence=[errorLevel,warnLevel,infoLevel,debugLevel,verboseLevel],below=!1,i=0;i<sequence.length;++i){var level=sequence[i];self.levels[level]=!below,level===initial&&(below=!0)}}function Pipeline(pipelineStages,closeStages,flushStages){var self=this;self.pipelineStages=pipelineStages,self.closeStages=closeStages||[],self.flushStages=flushStages||[];for(var head=function(evts){},makeHead=function(pipelineStage){var oldHead=head;return function(evts){pipelineStage(evts,oldHead)}},i=self.pipelineStages.length-1;i>=0;--i)head=makeHead(self.pipelineStages[i]);self.head=head}function LoggerConfiguration(){var self=this,minLevel=infoLevel,pipeline=[],closeStages=[],flushStages=[];self.pipe=function(pipelineStage){return pipeline.push(pipelineStage),self},self.minLevel=function(lvl){if(0!==pipeline.length){var lm=new LevelMap(lvl);return self.filter(function(evt){return lm.isEnabled(evt.level)})}return minLevel=(lvl||infoLevel).toUpperCase(),self},self.writeTo=function(sinkOrEmit,onError){return"function"!=typeof sinkOrEmit.emit&&"function"==typeof sinkOrEmit?self.writeTo({emit:sinkOrEmit,toString:function(){return sinkOrEmit.toString()}},minLevel):("function"==typeof sinkOrEmit.close&&closeStages.push(sinkOrEmit.close),self.pipe(function(evts,next){try{sinkOrEmit.emit(evts)}catch(err){if("function"==typeof onError)onError(err,evts,next);else{var notification=createEvent(errorLevel,"Failed to write to {sink}: {error}",sinkOrEmit,err.stack);notification.properties.isSelfLog=!0,next([notification])}}next(evts)}))},self.enrich=function(functionOrProperties,destructure){if("object"==typeof functionOrProperties)return self.enrich(function(evts){return functionOrProperties},destructure);if("function"==typeof functionOrProperties)return self.pipe(function(evts,next){enrich(evts,functionOrProperties(),destructure),next(evts)});throw new Error("Events can be enriched using either a function, or a hash of properties")},self.filter=function(filter){return self.pipe(function(evts,next){next(evts.filter(filter))})},self.batch=function(batchOptions){batchOptions||(batchOptions={}),batchOptions.batchSize||(batchOptions.batchSize=100),batchOptions.timeDuration||(batchOptions.timeDuration=1e3);var batchedLogEvents=[],lastFlushTime=(new Date).getTime(),flushBatch=null,flushStage=function(callback){flushBatch&&flushBatch(),callback()};return closeStages.push(flushStage),flushStages.push(flushStage),self.pipe(function(evts,next){batchFlushTimeout&&(clearTimeout(batchFlushTimeout),batchFlushTimeout=null);var batchFlushTimeout=null;flushBatch=function(){batchedLogEvents.reverse(),next(batchedLogEvents),batchedLogEvents=[],lastFlushTime=curTime,batchFlushTimeout=null,flushBatch=null},batchFlushTimeout=setTimeout(flushBatch,batchOptions.timeDuration),evts.forEach(function(evt){batchedLogEvents.push(evt)});var curTime=(new Date).getTime();(batchedLogEvents.length>=batchOptions.batchSize||batchOptions.timeDuration&&curTime-lastFlushTime>batchOptions.timeDuration)&&(batchFlushTimeout&&(clearTimeout(batchFlushTimeout),batchFlushTimeout=null),flushBatch())})},self.create=function(){var levelMap=new LevelMap(minLevel);return createLogger(levelMap,new Pipeline(pipeline,closeStages,flushStages))}}function StructuredLog(){var self=this;self.sink={},self.filter={},self.enrich={},self.filter.selfLog=function(){return function(evts){return evts.filter(function(evt){return evt.properties.isSelfLog})}},self.filter.notSelfLog=function(){return function(evts){return evts.filter(function(evt){return!evt.properties.isSelfLog})}},self.enrich.withStack=function(){return function(evts){try{throw new Error("getstack")}catch(err){var stack=err.stack;0===stack.indexOf("Error: getstack")&&(stack=stack.slice(stack.indexOf("\n")+1)),stack=stack.replace(/^[ ]+/g,""),evts.forEach(function(evt){evt.properties.hasOwnProperty("stack")||(evt.properties.stack=stack)})}}}}var capture=function(o,destructure){return"function"==typeof o?o.toString():"object"==typeof o?destructure||"function"==typeof o.toISOString?o:o.toString():o};MessageTemplate.prototype.bindProperties=function(positionalArgs){for(var self=this,result={},nextArg=0,i=0;i<self.tokens.length&&nextArg<positionalArgs.length;++i){var token=self.tokens[i];if("string"==typeof token.name){var p=positionalArgs[nextArg];result[token.name]=capture(p,token.destructure),nextArg++}}for(;nextArg<positionalArgs.length;){var px=positionalArgs[nextArg];"undefined"!=typeof px&&(result["a"+nextArg]=capture(px)),nextArg++}return result};var toText=function(o){if("undefined"==typeof o)return"undefined";if(null===o)return"null";if("string"==typeof o)return o;if("number"==typeof o)return o.toString();if("boolean"==typeof o)return o.toString();if("function"==typeof o.toISOString)return o.toISOString();if("object"==typeof o){var s=JSON.stringify(o);return s.length>70&&(s=s.slice(0,67)+"..."),s}return o.toString()};MessageTemplate.prototype.render=function(properties){for(var self=this,result=[],i=0;i<self.tokens.length;++i){var token=self.tokens[i];result.push("string"==typeof token.name?properties.hasOwnProperty(token.name)?toText(properties[token.name]):token.raw:token.text)}return result.join("")};var enrich=function(evts,properties,destructure){evts.forEach(function(evt){for(var prop in properties)properties.hasOwnProperty(prop)&&!evt.properties.hasOwnProperty(prop)&&(evt.properties[prop]=capture(properties[prop],destructure))})},createEvent=function(level,messageTemplate){var l=Array.prototype.shift.call(arguments),mt=Array.prototype.shift.call(arguments),parsedTemplate=new MessageTemplate(mt),boundProperties=parsedTemplate.bindProperties(arguments);return new LogEvent(new Date,l,parsedTemplate,boundProperties)};LogEvent.prototype.renderedMessage=function(){var self=this;return self.messageTemplate.render(self.properties)};var errorLevel="ERROR",warnLevel="WARN",infoLevel="INFO",debugLevel="DEBUG",verboseLevel="VERBOSE";LevelMap.prototype.isEnabled=function(level){var self=this;return self.levels[level||"NONE"]||!1},Pipeline.prototype.execute=function(evts){var self=this;self.head(evts)},Pipeline.prototype.close=function(cb){var self=this,remaining=self.closeStages.length;if(0===remaining)return void cb();var onClosed=function(){remaining--,0===remaining&&cb()};self.closeStages.forEach(function(closeStage){closeStage(onClosed)})},Pipeline.prototype.flush=function(cb){var self=this,remaining=self.flushStages.length;if(0===remaining)return void cb();var onFlushed=function(){remaining--,0===remaining&&cb()};self.flushStages.forEach(function(flushStage){flushStage(onFlushed)})};var createLogger=function(levelMap,pipeline){var self=function(){self.info.apply(null,arguments)};self.toString=function(){return"Logger"},self.emit=function(evts){evts=evts.filter(function(evt){return levelMap.isEnabled(evt.level)}),pipeline.execute(evts)};var invoke=function(level,messageTemplate,args){if(levelMap.isEnabled(level)){var parsedTemplate=new MessageTemplate(messageTemplate),boundProperties=parsedTemplate.bindProperties(args),evt=new LogEvent(new Date,level,parsedTemplate,boundProperties);pipeline.execute([evt])}};return self.verbose=function(messageTemplate){var mt=Array.prototype.shift.call(arguments);invoke(verboseLevel,mt,arguments)},self.debug=function(messageTemplate){var mt=Array.prototype.shift.call(arguments);invoke(debugLevel,mt,arguments)},self.info=function(messageTemplate){var mt=Array.prototype.shift.call(arguments);invoke(infoLevel,mt,arguments)},self.warn=function(messageTemplate){var mt=Array.prototype.shift.call(arguments);invoke(warnLevel,mt,arguments)},self.error=function(messageTemplate){var mt=Array.prototype.shift.call(arguments);invoke(errorLevel,mt,arguments)},self.enrich=function(properties,destructure){var enriched=new Pipeline([function(evts,next){enrich(evts,properties,destructure),pipeline.execute(evts),next(evts)}]);return createLogger(levelMap,enriched)},self.close=function(cb){pipeline.close(cb)},self.flush=function(cb){pipeline.flush(cb)},self};return StructuredLog.prototype.configure=function(){return new LoggerConfiguration},StructuredLog.prototype.event=createEvent,new StructuredLog});
!function(root,factory){"function"==typeof define&&define.amd?define([],factory):"object"==typeof exports?module.exports=factory():root.structuredLog.sink.console=factory()}(this,function(){function ConsoleSink(options){var self=this;self.toString=function(){return"ConsoleSink"},options=options||{};var write={log:function(){},info:function(){},warn:function(){},error:function(){}};"object"==typeof console&&(write.log=function(m,p){p?console.log(m,p):console.log(m)},write.info=function(m,p){p?console.info(m,p):console.info(m)},write.warn=function(m,p){p?console.warn(m,p):console.warn(m)},write.error=function(m,p){p?console.error(m,p):console.error(m)}),self.emit=function(evts){evts.forEach(function(evt){var formatted="";options.timestamp&&(formatted+=evt.timestamp.toISOString().replace("T"," ").replace("Z","")+" "),formatted+="["+evt.level.slice(0,3)+"] "+evt.messageTemplate.render(evt.properties),"ERROR"===evt.level?write.error(formatted,options.complete?evt.properties:null):"WARN"===evt.level?write.warn(formatted,options.complete?evt.properties:null):"INFO"===evt.level?write.info(formatted,options.complete?evt.properties:null):write.log(formatted,options.complete?evt.properties:null)})}}return function(options){return new ConsoleSink(options)}});